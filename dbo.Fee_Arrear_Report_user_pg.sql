CREATE FUNCTION "dbo"."Fee_Arrear_Report_user"(
    "amay_id" VARCHAR(50),
    "asmcl_id" VARCHAR(50),
    "amcl_id" VARCHAR(50),
    "amst_id" BIGINT,
    "fmt_id" VARCHAR(50),
    "mi_id" VARCHAR(50),
    "fmg_id" VARCHAR(50),
    "userid" VARCHAR(50),
    "fmgg_id" VARCHAR(50),
    "trmr_id" VARCHAR(50),
    "type" VARCHAR(100)
)
RETURNS TABLE(
    "AMST_Id" BIGINT,
    "Name" TEXT,
    "AMST_AdmNo" TEXT,
    "fyp_receipt_no" TEXT,
    "date" TEXT,
    "Balance" NUMERIC,
    "paid" NUMERIC,
    "Total" NUMERIC,
    "ASMCL_ClassName" TEXT,
    "ASMC_SectionName" TEXT,
    "FMT_Name" TEXT,
    "FMT_Id" BIGINT,
    "opening_balance" NUMERIC,
    "Excess" NUMERIC,
    "Waived" NUMERIC,
    "refunded" NUMERIC,
    "adjusted" NUMERIC,
    "TRMR_RouteName" TEXT,
    "FMCC_ConcessionName" TEXT,
    "TRMR_RouteNo" TEXT,
    "concession" NUMERIC,
    "payable" NUMERIC
)
LANGUAGE plpgsql
AS $$
DECLARE
    "fti_id" TEXT;
    "fmh_id" TEXT;
    "sqlinstall" TEXT;
    "sqlhead" TEXT;
    "monthyearsd" TEXT;
    "headid" TEXT;
    "query" TEXT;
    "temp" BIGINT;
    "temphead" BIGINT;
    "Row_count" BIGINT;
BEGIN

    IF "type" = 'students' THEN
        IF "amst_id" = 1 THEN
            "temp" := 0;
            "temphead" := 0;
            "headid" := 'D%';
            "sqlhead" := 'NULL';

            IF "mi_id" = '4' THEN
                IF "userid" = '364' THEN
                    IF "trmr_id" = '0' THEN
                        "query" := ';with cte as(SELECT DISTINCT "Adm_M_Student"."AMST_Id", COALESCE("dbo"."Adm_M_Student"."AMST_FirstName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_MiddleName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_LastName",'''') as "Name", "dbo"."Adm_M_Student"."AMST_AdmNo", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' Then '' '' else "dbo"."Fee_Y_Payment"."fyp_receipt_no" end as "fyp_receipt_no", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' then '' '' else CAST("dbo"."Fee_Y_Payment"."FYP_Date" AS DATE) end as date, sum("dbo"."Fee_Student_Status"."FSS_ToBePaid") AS "Balance", sum("dbo"."Fee_Student_Status"."FSS_PaidAmount") AS paid, sum("dbo"."Fee_Student_Status"."fss_totaltobepaid") as total, "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", sum("FSS_OBArrearAmount") opening_balance, sum("FSS_OBExcessAmount") "Excess", sum("FSS_WaivedAmount") as "Waived", sum("FSS_RefundAmount") as refunded, sum("FSS_AdjustedAmount") adjusted, "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id", "trn"."TR_Master_Route"."TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo" FROM "dbo"."Fee_Student_Status" INNER JOIN "dbo"."Fee_Y_Payment_School_Student" ON "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" = "dbo"."Fee_Student_Status"."AMST_Id" INNER JOIN "dbo"."Fee_Y_Payment" ON "dbo"."Fee_Y_Payment_School_Student"."FYP_Id" = "dbo"."Fee_Y_Payment"."FYP_Id" INNER JOIN "dbo"."Fee_Master_Terms_FeeHeads" ON "dbo"."Fee_Master_Terms_FeeHeads"."FMH_Id" = "dbo"."Fee_Student_Status"."FMH_Id" AND "dbo"."Fee_Master_Terms_FeeHeads"."FTI_Id" = "dbo"."Fee_Student_Status"."FTI_Id" INNER JOIN "dbo"."Adm_M_Student" ON "dbo"."Adm_M_Student"."AMST_Id" = "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" INNER JOIN "dbo"."Fee_Master_Group" ON "dbo"."Fee_Master_Group"."FMG_Id" = "dbo"."Fee_Student_Status"."FMG_Id" INNER JOIN "dbo"."Adm_School_Y_Student" ON "dbo"."Adm_M_Student"."AMST_Id" = "dbo"."Adm_School_Y_Student"."AMST_Id" INNER JOIN "dbo"."Adm_School_M_Class" ON "dbo"."Adm_School_Y_Student"."ASMCL_Id" = "dbo"."Adm_School_M_Class"."ASMCL_Id" INNER JOIN "dbo"."Adm_School_M_Section" ON "dbo"."Adm_School_Y_Student"."ASMS_Id" = "dbo"."Adm_School_M_Section"."ASMS_Id" INNER JOIN "dbo"."Fee_Master_Terms" ON "dbo"."Fee_Master_Terms_FeeHeads"."FMT_Id" = "dbo"."Fee_Master_Terms"."FMT_Id" inner join "Adm_School_M_Academic_Year" on "Adm_School_M_Academic_Year"."ASMAY_Id" = "Adm_School_Y_Student"."ASMAY_Id" and "Adm_School_M_Academic_Year"."ASMAY_Id" = "fee_student_status"."ASMAY_Id" inner join "trn"."TR_Student_Route" on "trn"."TR_Student_Route"."AMST_Id" = "dbo"."Adm_M_Student"."AMST_Id" inner join "trn"."TR_Master_Route" on "trn"."TR_Student_Route"."TRMR_Id" = "trn"."TR_Master_Route"."TRMR_Id" inner join "Fee_Master_Concession" on "Fee_Master_Concession"."FMCC_Id" = "Adm_M_Student"."AMST_Concession_Type" WHERE ("dbo"."Adm_School_Y_Student"."asmay_id" = ''' || "amay_id" || ''') and ("Adm_M_Student"."AMST_ActiveFlag" = 1) and ("Adm_School_Y_Student"."AMAY_ActiveFlag" = 1) and ("dbo"."Adm_M_Student"."AMST_SOL" = ''S'') and ("Fee_Y_Payment"."user_id" = ''' || "userid" || ''') and ("dbo"."Fee_Y_Payment"."MI_Id" = ''' || "mi_id" || ''') AND ("dbo"."Fee_Student_Status"."FMH_Id" NOT IN (100)) AND ("dbo"."Fee_Master_Terms_FeeHeads"."FMT_Id" in (' || "fmt_id" || ')) and ("dbo"."Adm_School_M_Class"."asmcl_id" = ' || "asmcl_id" || ') and ("dbo"."Adm_School_M_Section"."asms_id" = ' || "amcl_id" || ') and ("Fee_Student_Status"."FSS_PaidAmount" > 0 or "Fee_Student_Status"."FSS_ToBePaid" > 0) and ("dbo"."Fee_Student_Status"."FMG_Id" IN(select distinct "FMG_Id" from "Fee_Master_Group_Grouping" inner join "Fee_Master_Group_Grouping_Groups" on "Fee_Master_Group_Grouping"."FMGG_Id" = "Fee_Master_Group_Grouping_Groups"."FMGG_Id" where "FMGG_GroupCode" = ''1'' and "FMGG_ActiveFlag" = 1 and "MI_Id" = ''' || "mi_id" || ''' and "Fee_Master_Group_Grouping"."FMGG_Id" in (' || "fmgg_id" || '))) group by "Adm_M_Student"."AMST_Id", "AMST_FirstName", "AMST_MiddleName", "AMST_LastName", "AMST_AdmNo", "fyp_receipt_no", "FYP_Date", "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id", "trn"."TR_Master_Route"."TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo") select "AMST_Id", "Name", "AMST_AdmNo", "fyp_receipt_no", replace(CAST(date AS TEXT), ''1900-01-01'', '' '') as date, sum("Balance") as "Balance", sum(paid) as paid, sum(total) as "Total", sum(opening_balance) as opening_balance, sum("Excess") as "Excess", sum("Waived") as "Waived", sum(refunded) as refunded, sum(adjusted) as adjusted, "ASMCL_ClassName", "ASMC_SectionName", "FMT_Name", "FMT_Id", "TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo" from cte group by "AMST_Id", "AMST_AdmNo", "Name", "fyp_receipt_no", date, "ASMCL_ClassName", "ASMC_SectionName", "FMT_Name", "fmt_id", "TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo"';
                    ELSE
                        "query" := ';with cte as(SELECT DISTINCT "Adm_M_Student"."AMST_Id", COALESCE("dbo"."Adm_M_Student"."AMST_FirstName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_MiddleName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_LastName",'''') as "Name", "dbo"."Adm_M_Student"."AMST_AdmNo", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' Then '' '' else "dbo"."Fee_Y_Payment"."fyp_receipt_no" end as "fyp_receipt_no", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' then '' '' else CAST("dbo"."Fee_Y_Payment"."FYP_Date" AS DATE) end as date, sum("dbo"."Fee_Student_Status"."FSS_ToBePaid") AS "Balance", sum("dbo"."Fee_Student_Status"."FSS_PaidAmount") AS paid, sum("dbo"."Fee_Student_Status"."fss_totaltobepaid") as total, "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", sum("FSS_OBArrearAmount") opening_balance, sum("FSS_OBExcessAmount") "Excess", sum("FSS_WaivedAmount") as "Waived", sum("FSS_RefundAmount") as refunded, sum("FSS_AdjustedAmount") adjusted, "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id", "trn"."TR_Master_Route"."TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo" FROM "dbo"."Fee_Student_Status" INNER JOIN "dbo"."Fee_Y_Payment_School_Student" ON "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" = "dbo"."Fee_Student_Status"."AMST_Id" INNER JOIN "dbo"."Fee_Y_Payment" ON "dbo"."Fee_Y_Payment_School_Student"."FYP_Id" = "dbo"."Fee_Y_Payment"."FYP_Id" INNER JOIN "dbo"."Fee_Master_Terms_FeeHeads" ON "dbo"."Fee_Master_Terms_FeeHeads"."FMH_Id" = "dbo"."Fee_Student_Status"."FMH_Id" AND "dbo"."Fee_Master_Terms_FeeHeads"."FTI_Id" = "dbo"."Fee_Student_Status"."FTI_Id" INNER JOIN "dbo"."Adm_M_Student" ON "dbo"."Adm_M_Student"."AMST_Id" = "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" INNER JOIN "dbo"."Fee_Master_Group" ON "dbo"."Fee_Master_Group"."FMG_Id" = "dbo"."Fee_Student_Status"."FMG_Id" INNER JOIN "dbo"."Adm_School_Y_Student" ON "dbo"."Adm_M_Student"."AMST_Id" = "dbo"."Adm_School_Y_Student"."AMST_Id" INNER JOIN "dbo"."Adm_School_M_Class" ON "dbo"."Adm_School_Y_Student"."ASMCL_Id" = "dbo"."Adm_School_M_Class"."ASMCL_Id" INNER JOIN "dbo"."Adm_School_M_Section" ON "dbo"."Adm_School_Y_Student"."ASMS_Id" = "dbo"."Adm_School_M_Section"."ASMS_Id" INNER JOIN "dbo"."Fee_Master_Terms" ON "dbo"."Fee_Master_Terms_FeeHeads"."FMT_Id" = "dbo"."Fee_Master_Terms"."FMT_Id" inner join "Adm_School_M_Academic_Year" on "Adm_School_M_Academic_Year"."ASMAY_Id" = "Adm_School_Y_Student"."ASMAY_Id" and "Adm_School_M_Academic_Year"."ASMAY_Id" = "fee_student_status"."ASMAY_Id" inner join "trn"."TR_Student_Route" on "trn"."TR_Student_Route"."AMST_Id" = "dbo"."Adm_M_Student"."AMST_Id" inner join "trn"."TR_Master_Route" on "trn"."TR_Student_Route"."TRMR_Id" = "trn"."TR_Master_Route"."TRMR_Id" inner join "Fee_Master_Concession" on "Fee_Master_Concession"."FMCC_Id" = "Adm_M_Student"."AMST_Concession_Type" WHERE ("dbo"."Adm_School_Y_Student"."asmay_id" = ''' || "amay_id" || ''') and ("Adm_M_Student"."AMST_ActiveFlag" = 1) and ("Adm_School_Y_Student"."AMAY_ActiveFlag" = 1) and ("dbo"."Adm_M_Student"."AMST_SOL" = ''S'') and ("Fee_Y_Payment"."user_id" = ''' || "userid" || ''') and ("dbo"."Fee_Y_Payment"."MI_Id" = ''' || "mi_id" || ''') AND ("dbo"."Fee_Student_Status"."FMH_Id" NOT IN (100)) AND ("dbo"."Fee_Master_Terms_FeeHeads"."FMT_Id" in (' || "fmt_id" || ')) and ("Fee_Student_Status"."FSS_PaidAmount" > 0 or "Fee_Student_Status"."FSS_ToBePaid" > 0) and ("dbo"."Fee_Student_Status"."FMG_Id" IN(select distinct "FMG_Id" from "Fee_Master_Group_Grouping" inner join "Fee_Master_Group_Grouping_Groups" on "Fee_Master_Group_Grouping"."FMGG_Id" = "Fee_Master_Group_Grouping_Groups"."FMGG_Id" where "FMGG_GroupCode" = ''1'' and "FMGG_ActiveFlag" = 1 and "MI_Id" = ''' || "mi_id" || ''' and "Fee_Master_Group_Grouping"."FMGG_Id" in (' || "fmgg_id" || '))) and ("trn"."TR_Master_Route"."TRMR_Id" = ' || "trmr_id" || ') group by "Adm_M_Student"."AMST_Id", "AMST_FirstName", "AMST_MiddleName", "AMST_LastName", "AMST_AdmNo", "fyp_receipt_no", "FYP_Date", "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id", "trn"."TR_Master_Route"."TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo") select "AMST_Id", "Name", "AMST_AdmNo", "fyp_receipt_no", replace(CAST(date AS TEXT), ''1900-01-01'', '' '') as date, sum("Balance") as "Balance", sum(paid) as paid, sum(total) as "Total", sum(opening_balance) as opening_balance, sum("Excess") as "Excess", sum("Waived") as "Waived", sum(refunded) as refunded, sum(adjusted) as adjusted, "ASMCL_ClassName", "ASMC_SectionName", "FMT_Name", "FMT_Id", "TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo" from cte group by "AMST_Id", "AMST_AdmNo", "Name", "fyp_receipt_no", date, "ASMCL_ClassName", "ASMC_SectionName", "FMT_Name", "fmt_id", "TRMR_RouteName", "FMCC_ConcessionName", "TRMR_RouteNo"';
                    END IF;
                ELSE
                    "query" := ';with cte as(SELECT DISTINCT "Adm_M_Student"."AMST_Id", COALESCE("dbo"."Adm_M_Student"."AMST_FirstName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_MiddleName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_LastName",'''') as "Name", "dbo"."Adm_M_Student"."AMST_AdmNo", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' Then '' '' else "dbo"."Fee_Y_Payment"."fyp_receipt_no" end as "fyp_receipt_no", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' then '' '' else CAST("dbo"."Fee_Y_Payment"."FYP_Date" AS DATE) end as date, sum("dbo"."Fee_Student_Status"."FSS_ToBePaid") AS "Balance", sum("dbo"."Fee_Student_Status"."FSS_PaidAmount") AS paid, sum("dbo"."Fee_Student_Status"."fss_totaltobepaid") as total, "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id", "FMCC_ConcessionName" FROM "dbo"."Fee_Student_Status" INNER JOIN "dbo"."Fee_Y_Payment_School_Student" ON "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" = "dbo"."Fee_Student_Status"."AMST_Id" INNER JOIN "dbo"."Fee_Y_Payment" ON "dbo"."Fee_Y_Payment_School_Student"."FYP_Id" = "dbo"."Fee_Y_Payment"."FYP_Id" INNER JOIN "dbo"."Fee_Master_Terms_FeeHeads" ON "dbo"."Fee_Master_Terms_FeeHeads"."FMH_Id" = "dbo"."Fee_Student_Status"."FMH_Id" AND "dbo"."Fee_Master_Terms_FeeHeads"."FTI_Id" = "dbo"."Fee_Student_Status"."FTI_Id" INNER JOIN "dbo"."Adm_M_Student" ON "dbo"."Adm_M_Student"."AMST_Id" = "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" INNER JOIN "dbo"."Fee_Master_Group" ON "dbo"."Fee_Master_Group"."FMG_Id" = "dbo"."Fee_Student_Status"."FMG_Id" INNER JOIN "dbo"."Adm_School_Y_Student" ON "dbo"."Adm_M_Student"."AMST_Id" = "dbo"."Adm_School_Y_Student"."AMST_Id" INNER JOIN "dbo"."Adm_School_M_Class" ON "dbo"."Adm_School_Y_Student"."ASMCL_Id" = "dbo"."Adm_School_M_Class"."ASMCL_Id" INNER JOIN "dbo"."Adm_School_M_Section" ON "dbo"."Adm_School_Y_Student"."ASMS_Id" = "dbo"."Adm_School_M_Section"."ASMS_Id" INNER JOIN "dbo"."Fee_Master_Terms" ON "dbo"."Fee_Master_Terms_FeeHeads"."FMT_Id" = "dbo"."Fee_Master_Terms"."FMT_Id" inner join "Adm_School_M_Academic_Year" on "Adm_School_M_Academic_Year"."ASMAY_Id" = "Adm_School_Y_Student"."ASMAY_Id" and "Adm_School_M_Academic_Year"."ASMAY_Id" = "fee_student_status"."ASMAY_Id" inner join "Fee_Master_Concession" on "Fee_Master_Concession"."FMCC_Id" = "Adm_M_Student"."AMST_Concession_Type" WHERE ("dbo"."Adm_School_Y_Student"."asmay_id" = ''' || "amay_id" || ''') and ("Adm_M_Student"."AMST_ActiveFlag" = 1) and ("Adm_School_Y_Student"."AMAY_ActiveFlag" = 1) and ("dbo"."Adm_M_Student"."AMST_SOL" = ''S'') and ("Fee_Y_Payment"."user_id" = ''' || "userid" || ''') and ("dbo"."Fee_Y_Payment"."MI_Id" = ''' || "mi_id" || ''') AND ("dbo"."Fee_Student_Status"."FMH_Id" NOT IN (100)) AND ("dbo"."Fee_Master_Terms_FeeHeads"."FMT_Id" in (' || "fmt_id" || ')) and ("dbo"."Adm_School_M_Class"."asmcl_id" = ' || "asmcl_id" || ') and ("dbo"."Adm_School_M_Section"."asms_id" = ' || "amcl_id" || ') and ("Fee_Student_Status"."FSS_PaidAmount" > 0 or "Fee_Student_Status"."FSS_ToBePaid" > 0) and ("dbo"."Fee_Student_Status"."FMG_Id" IN(select distinct "FMG_Id" from "Fee_Master_Group_Grouping" inner join "Fee_Master_Group_Grouping_Groups" on "Fee_Master_Group_Grouping"."FMGG_Id" = "Fee_Master_Group_Grouping_Groups"."FMGG_Id" where "FMGG_GroupCode" = ''1'' and "FMGG_ActiveFlag" = 1 and "MI_Id" = ''' || "mi_id" || ''' and "Fee_Master_Group_Grouping"."FMGG_Id" in (' || "fmgg_id" || '))) group by "Adm_M_Student"."AMST_Id", "AMST_FirstName", "AMST_MiddleName", "AMST_LastName", "AMST_AdmNo", "fyp_receipt_no", "FYP_Date", "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id", "FMCC_ConcessionName") select "AMST_Id", "Name", "AMST_AdmNo", "fyp_receipt_no", replace(CAST(date AS TEXT), ''1900-01-01'', '' '') as date, sum("Balance") as "Balance", sum(paid) as paid, sum(total) as "Total", "ASMCL_ClassName", "ASMC_SectionName", "FMT_Name", "FMT_Id", "FMCC_ConcessionName" from cte group by "AMST_Id", "AMST_AdmNo", "Name", "fyp_receipt_no", date, "ASMCL_ClassName", "ASMC_SectionName", "FMT_Name", "fmt_id", "FMCC_ConcessionName"';
                END IF;
            ELSE
                "query" := ';with cte as(SELECT DISTINCT "Adm_M_Student"."AMST_Id", COALESCE("dbo"."Adm_M_Student"."AMST_FirstName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_MiddleName",'''') || '' '' || COALESCE("dbo"."Adm_M_Student"."AMST_LastName",'''') as "Name", "dbo"."Adm_M_Student"."AMST_AdmNo", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' Then '' '' else "dbo"."Fee_Y_Payment"."fyp_receipt_no" end as "fyp_receipt_no", case when "dbo"."Fee_Y_Payment"."fyp_receipt_no" like ''' || "headid" || ''' or "dbo"."Fee_Y_Payment"."fyp_receipt_no" !~ ''[^0-9]'' then '' '' else CAST("dbo"."Fee_Y_Payment"."FYP_Date" AS DATE) end as date, sum("dbo"."Fee_Student_Status"."FSS_ToBePaid") AS "Balance", sum("dbo"."Fee_Student_Status"."FSS_PaidAmount") AS paid, sum("dbo"."Fee_Student_Status"."fss_totaltobepaid") as total, "dbo"."Adm_School_M_Class"."ASMCL_ClassName", "dbo"."Adm_School_M_Section"."ASMC_SectionName", "dbo"."Fee_Master_Terms"."FMT_Name", "dbo"."Fee_Master_Terms"."fmt_id" FROM "dbo"."Fee_Student_Status" INNER JOIN "dbo"."Fee_Y_Payment_School_Student" ON "dbo"."Fee_Y_Payment_School_Student"."AMST_Id" = "dbo"."Fee_Student_Status"."AMST_Id" INNER JOIN "dbo"."Fee_Y_Payment" ON "dbo"."Fee